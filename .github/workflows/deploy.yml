name: Deploy PNCP Jobs para Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Testar conectividade
        run: |
          echo "ğŸ” Testando ping para ${{ secrets.HOST }}"
          ping -c 3 ${{ secrets.HOST }} || echo "âš ï¸ Ping falhou (normal se ICMP bloqueado)"
          
          echo "ğŸ” Testando porta SSH 22"
          nc -zv ${{ secrets.HOST }} 22 || echo "âš ï¸ Porta 22 nÃ£o acessÃ­vel"
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script: |
            set -e
            echo "ğŸš€ Conectado ao servidor!"
            echo "ğŸ“‚ DiretÃ³rio atual: $(pwd)"
            echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
            
            cd /opt/pncp-jobs
            
            # Backup do .env
            if [ -f .env ]; then
              cp .env .env.backup
              echo "âœ… Backup do .env criado"
            fi
            
            # Atualizar cÃ³digo
            echo "ğŸ“¥ Fazendo git pull..."
            git pull origin main
            echo "âœ… CÃ³digo atualizado"
            
            # Restaurar .env
            if [ -f .env.backup ]; then
              mv .env.backup .env
              echo "âœ… .env restaurado"
            fi
            
            # Atualizar dependÃªncias
            echo "ğŸ“¦ Atualizando dependÃªncias..."
            source venv/bin/activate
            pip install -r requirements.txt --upgrade --quiet
            echo "âœ… DependÃªncias atualizadas"
            
            # Health check
            echo "ğŸ” Verificando ambiente..."
            python3 -c "from dotenv import load_dotenv; load_dotenv(); import os; print('âœ… DATABASE_URL:', os.getenv('DATABASE_URL')[:30] + '...')" || echo "âš ï¸ Env check falhou"
            
            echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
            
      - name: Notificar sucesso
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸ“Š Jobs agendados: 08:00 (Pipeline) e 10:00 (Emails)"
        
      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou!"
          echo "Verifique:"
          echo "1. Secret SSH_PRIVATE_KEY estÃ¡ correto?"
          echo "2. Chave pÃºblica estÃ¡ em ~/.ssh/authorized_keys no servidor?"
          echo "3. Servidor estÃ¡ rodando?"