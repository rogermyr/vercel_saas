name: Deploy PNCP Jobs para Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Iniciando deploy..."
            
            cd /opt/pncp-jobs
            
            # Backup do .env
            if [ -f .env ]; then
              cp .env .env.backup
              echo "‚úÖ Backup do .env criado"
            fi
            
            # Atualizar c√≥digo
            git pull origin main
            echo "‚úÖ C√≥digo atualizado"
            
            # Restaurar .env
            if [ -f .env.backup ]; then
              mv .env.backup .env
              echo "‚úÖ .env restaurado"
            fi
            
            # Atualizar depend√™ncias
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            echo "‚úÖ Depend√™ncias atualizadas"
            
            # Health check
            python3 -c "from api.models import db; print('‚úÖ Database OK')" || echo "‚ö†Ô∏è Database check falhou"
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            
      - name: Notificar sucesso
        if: success()
        run: echo "‚úÖ Deploy realizado com sucesso para Hetzner"
        
      - name: Notificar falha
        if: failure()
        run: echo "‚ùå Deploy falhou! Verifique os logs"