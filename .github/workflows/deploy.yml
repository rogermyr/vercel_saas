name: Deploy PNCP Jobs para Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Deploy no servidor
        run: |
          set -e
          echo "ğŸš€ Iniciando deploy no servidor Hetzner..."
          echo "ğŸ“‚ DiretÃ³rio de trabalho: $(pwd)"
          echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
          
          cd /opt/pncp-jobs
          
          # Backup do .env
          if [ -f .env ]; then
            cp .env .env.backup
            echo "âœ… Backup do .env criado"
          fi
          
          # Copiar cÃ³digo atualizado do checkout
          echo "ğŸ“¥ Copiando cÃ³digo atualizado..."
          rsync -av --exclude='.git' --exclude='venv' --exclude='.env' --exclude='__pycache__' --exclude='*.pyc' $GITHUB_WORKSPACE/ /opt/pncp-jobs/
          echo "âœ… CÃ³digo atualizado"
          
          # Restaurar .env
          if [ -f .env.backup ]; then
            mv .env.backup .env
            echo "âœ… .env restaurado"
          fi
          
          # Atualizar variÃ¡veis de ambiente com valores dos secrets
          echo "ğŸ”§ Atualizando variÃ¡veis de ambiente..."
          echo "MAIL_SERVER=${{ secrets.MAIL_SERVER }}" >> .env
          echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
          echo "MAIL_USE_TLS=True" >> .env  # Valor fixo, ajuste se necessÃ¡rio
          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
          echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
          echo "MAIL_DEFAULT_SENDER=${{ secrets.MAIL_DEFAULT_SENDER }}" >> .env
          echo "âœ… VariÃ¡veis de ambiente atualizadas"
          
          # Atualizar dependÃªncias
          echo "ğŸ“¦ Atualizando dependÃªncias..."
          source venv/bin/activate
          pip install -r requirements.txt --upgrade --quiet
          echo "âœ… DependÃªncias atualizadas"
          
          # Health check
          echo "ğŸ” Verificando ambiente..."
          python3 -c "from dotenv import load_dotenv; load_dotenv(); import os; print('âœ… DATABASE_URL configurada')" || echo "âš ï¸ Env check falhou"
          
          # Verificar cron
          if [ -f /etc/cron.d/pncp-jobs ]; then
            echo "âœ… Cron jobs configurados (08:00 Pipeline, 10:00 Emails)"
          else
            echo "âš ï¸ Cron jobs nÃ£o encontrados em /etc/cron.d/pncp-jobs"
          fi
          
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          
      - name: Notificar sucesso
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso no servidor Hetzner!"
          echo "ğŸ“Š Jobs agendados: 08:00 (Pipeline) e 10:00 (Emails)"
        
      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou!"
          echo "Verifique os logs acima para detalhes"